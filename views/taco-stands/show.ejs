<%- include('../partials/header.ejs') %>

<% if (avgRating.length > 0) { %>
  <div><%= ratingD %> (<%=average%>, <%= avgRating.length %> reviews)</div>
  <% } else { %>
  <div>(No ratings yet)</div>
<% } %>

<% if (user && currentStand.owner.toString() === user._id.toString()) { %>
  <a href="/taco-stands/<%= currentStand._id %>/edit">Edit Taco Stand</a>
  <form action="/taco-stands/<%= currentStand._id %>?_method=DELETE" method="POST">
    <button type="submit">Delete Taco Stand</button>
  </form>
<% } %>

<ul>
  <li>
    <u><strong>Details:</strong></u>
    <ul>
      <li>
        <strong>City: </strong> <%= currentStand.city %>
      </li>
      <li>
        <strong>Price: </strong> <%= currentStand.price %>
      </li>
      <li>
      <strong>Days Open:</strong>
      <% currentStand.day.forEach((day) => { %>
        <ul><li><%= day %></li></ul>
      <% }) %>
        <li><strong>Hours: </strong> <%= `${currentStand.hour[0]}${currentStand.hour[1]} - ${currentStand.hour[2]}${currentStand.hour[3]}`%></li>
      </ul>
    </li>
</ul>
  <li>
    <u><strong>Reviews:</strong></u>
    <ul>
      <% currentStand.reviews.forEach(review => { %>
        <li><strong>User: </strong> <%= review.username %></li>
        <li>
          <strong>Rating: </strong>
          <% for (let i = 0; i < review.rating; i++) { %>
            ðŸŒ®
          <% } %>
        </li>
        <li><strong>Comment: </strong> <%= review.comment %></li>
        
        <% if (review.createdAt.toString() === review.updatedAt.toString()) { %>
          <li><strong>Created at:</strong> <%= new Date(review.createdAt).toLocaleString() %></li><br>
          <% } else { %>
            <li><strong>Updated at:</strong> <%= new Date(review.updatedAt).toLocaleString() %></li><br>
        <% } %>
        <% if (user && user.username === review.username) { %>
          <li>
            <a href="/taco-stands/<%= currentStand._id %>/reviews/edit">Edit Review</a>
          </li>
          <form action="/taco-stands/<%= currentStand._id %>/reviews?_method=DELETE" method="POST">
            <input type="hidden" name="reviewId" value="<%= review._id %>">
            <button type="submit">Delete Review</button>
          </form><br>
          <% } %>
        <% }) %>
      </ul>
  </li>
</ul>

<% let userHasReviewed = false %>

<% currentStand.reviews.forEach((review) => { %>
  <% if (user && user.username === review.username) { %>
    <% userHasReviewed = true %>
  <% } %>
<% }) %>

<% if (user && !userHasReviewed) { %>
  <a href="/taco-stands/<%= currentStand._id %>/reviews/new">Add Review</a>
<% } else if (!user) { %>
  <p><a href="/login">Please log in to add a review.</a></p>
<% } %>




<%- include('../partials/footer.ejs') %>