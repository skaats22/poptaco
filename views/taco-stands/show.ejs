<%- include('../partials/header.ejs') %>

<link rel="stylesheet" href="/css/show.css">

<% if (avgRating.length > 0) { %>
  <div class="rating"><%= ratingD %> (<%=average%>, <%= avgRating.length %> reviews)</div>
  <% } else { %>
  <div class="rating">(No ratings yet)</div>
<% } %>

<div class="details">
    <ul>
      <li>
        <u>Price</u>: <%= currentStand.price %>
      </li>
      <li>
        <u>City</u>: <%= currentStand.city %>
      </li>
      <li>
      <u>Days Open</u>: 
      <% currentStand.day.forEach((day) => { %>
        <ul><li><%= day %></li></ul>
      <% }) %>
        <li><u>Hours</u>: <%= `${currentStand.hour[0]}${currentStand.hour[1]} - ${currentStand.hour[2]}${currentStand.hour[3]}`%></li>
      </ul>
  </li>
</div>

<div class="edit">
  <% if (user && currentStand.owner.toString() === user._id.toString()) { %>
    <a href="/taco-stands/<%= currentStand._id %>/edit"><button>Edit Taco Stand</button></a>
    <form action="/taco-stands/<%= currentStand._id %>?_method=DELETE" method="POST">
      <button type="submit">Delete Taco Stand</button>
    </form>
  <% } %>
</div>

<br>
<h3><u>Reviews</u>:</h3>
<br>

<div class="reviews">
  <% currentStand.reviews.forEach(review => { %>
    <div class="review-info">
      <u><%= review.username %></u><br>
      <% for (let i = 0; i < review.rating; i++) { %>
        ðŸŒ®
      <% } %><br>
      <% if (review.createdAt.toString() === review.updatedAt.toString()) { %>
        <%= new Date(review.createdAt).toLocaleString() %><br>
      <% } else { %>
        <%= new Date(review.updatedAt).toLocaleString() %><br>
      <% } %>
      <% if (user && user.username === review.username) { %>
        <a href="/taco-stands/<%= currentStand._id %>/reviews/edit"><button>Edit Review</button></a>
        <form action="/taco-stands/<%= currentStand._id %>/reviews?_method=DELETE" method="POST">
          <input type="hidden" name="reviewId" value="<%= review._id %>">
          <button type="submit">Delete Review</button>
        </form>
        <% } %>
      </div>
    <div class="comment">
      <%= review.comment %>
    </div>
  <% }) %>
</div>

<% let userHasReviewed = false %>

<% currentStand.reviews.forEach((review) => { %>
  <% if (user && user.username === review.username) { %>
    <% userHasReviewed = true %>
  <% } %>
<% }) %>

<div id="login">
  <% if (user && !userHasReviewed) { %>
    <a href="/taco-stands/<%= currentStand._id %>/reviews/new">Add Review</a>
  <% } else if (!user) { %>
    <p><a href="/login">Please log in to add a review.</a></p>
  <% } %>
</div>




<%- include('../partials/footer.ejs') %>